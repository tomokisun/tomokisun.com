name: Preview

on:
  pull_request:
    types: [opened, synchronize, reopened]

concurrency:
  group: preview-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  preview:
    name: Deploy Preview
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      deployments: write
    outputs:
      preview-url: ${{ steps.preview-url.outputs.url }}
    steps:
      - uses: actions/checkout@v6
      - uses: oven-sh/setup-bun@v2
      - run: bun install --frozen-lockfile
      - run: bun run build

      - name: Deploy Preview
        id: deploy
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: deploy --env preview
          packageManager: bun

      - name: Extract Preview URL
        id: preview-url
        env:
          DEPLOYMENT_URL: ${{ steps.deploy.outputs.deployment-url }}
          COMMAND_OUTPUT: ${{ steps.deploy.outputs.command-output }}
        run: |
          URL="$DEPLOYMENT_URL"
          # Validate URL starts with https://
          if [[ ! "$URL" =~ ^https:// ]]; then
            # Fallback: extract workers.dev URL from command output
            URL=$(echo "$COMMAND_OUTPUT" | grep -oE 'https://[^ ]+\.workers\.dev' | head -1)
          fi
          echo "url=${URL}" >> "$GITHUB_OUTPUT"
          echo "Preview URL: ${URL}"

      - name: Comment Preview URL
        uses: actions/github-script@v8
        with:
          script: |
            const url = '${{ steps.preview-url.outputs.url }}';
            const body = [
              '## Preview Deployment',
              '',
              url ? `URL: ${url}` : 'Preview URL not available',
              '',
              `_Commit: ${{ github.event.pull_request.head.sha }}_`,
            ].join('\n');

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            const existing = comments.find(c =>
              c.user.type === 'Bot' && c.body.includes('## Preview Deployment')
            );

            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body,
              });
            }

  lighthouse:
    name: Lighthouse CI
    needs: preview
    if: needs.preview.outputs.preview-url != ''
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - uses: actions/checkout@v6

      - name: Run Lighthouse CI
        id: lhci
        uses: treosh/lighthouse-ci-action@v12
        with:
          urls: ${{ needs.preview.outputs.preview-url }}
          configPath: ./lighthouserc.json
          uploadArtifacts: true
          temporaryPublicStorage: true
          runs: 3

      - name: Comment Lighthouse Results
        if: always()
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');
            let body = '## Lighthouse Results\n\n';

            try {
              const manifestPath = '.lighthouseci/manifest.json';
              if (fs.existsSync(manifestPath)) {
                const manifest = JSON.parse(fs.readFileSync(manifestPath, 'utf8'));
                const last = manifest[manifest.length - 1];
                const report = JSON.parse(fs.readFileSync(last.jsonPath, 'utf8'));
                const cats = report.categories;

                const score = (key) => Math.round((cats[key]?.score || 0) * 100);
                const icon = (s) => s >= 90 ? 'ðŸŸ¢' : s >= 50 ? 'ðŸŸ¡' : 'ðŸ”´';

                const perf = score('performance');
                const a11y = score('accessibility');
                const bp = score('best-practices');
                const seo = score('seo');

                body += '| Category | Score |\n|---|---|\n';
                body += `| ${icon(perf)} Performance | ${perf} |\n`;
                body += `| ${icon(a11y)} Accessibility | ${a11y} |\n`;
                body += `| ${icon(bp)} Best Practices | ${bp} |\n`;
                body += `| ${icon(seo)} SEO | ${seo} |\n`;

                if (last.htmlPath) {
                  body += `\n[Full Report](${last.htmlPath})`;
                }
              } else {
                body += '_Results not available._\n';
              }
            } catch (e) {
              body += `_Error: ${e.message}_\n`;
            }

            body += `\n\n_Commit: ${{ github.event.pull_request.head.sha }}_`;

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            const existing = comments.find(c =>
              c.user.type === 'Bot' && c.body.includes('## Lighthouse Results')
            );

            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body,
              });
            }
